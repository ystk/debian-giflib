From 799eb6a3af8a3dd81e2429bf11a72a57e541f908 Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Sun, 17 Mar 2019 12:37:21 -0400
Subject: [PATCH] Address SF bug #119: MemorySanitizer: FPE on unknown address

---
 dgif_lib.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

From e6a3b6b197364acbd34607c423f0d45b88e1ae4b Mon Sep 17 00:00:00 2001
From: "Eric S. Raymond" <esr@thyrsus.com>
Date: Fri, 8 Feb 2019 17:48:17 -0500
Subject: [PATCH] Address SF issue #104: Ineffective bounds check in DGifSlurp

Fortunately, the overflow of Width*Height is not harmful for platforms
where sizeof(int) >=4, since Width and Height are read as 16-bit
values from the gif file and the result is cast to size_t afterwards.
---
 lib/dgif_lib.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

From b7b3c0488251ece31ac244dcad2822532add055f Mon Sep 17 00:00:00 2001
From: abadger1999 <abadger1999>
Date: Wed, 23 Jan 2008 16:16:13 +0000
Subject: [PATCH] One more shot at fixing the size problem.  Have to cast one
 of the variables to the proper type so we don't overflow *during* the
 multiplication operation.

---
 lib/dgif_lib.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

From 064b68ab761c90ad74124240663c80b4955e3beb Mon Sep 17 00:00:00 2001
From: abadger1999 <abadger1999>
Date: Tue, 22 Jan 2008 19:08:25 +0000
Subject: [PATCH] * Properly detect integer overflows in DGifSlurp().  Thanks
 to Antony Dovgal   for the patch. * Fix configure to not error when stdarg.h
 is not present but varargs.h is.

---
 configure.ac   | 16 +++++++++++++---
 lib/dgif_lib.c | 23 ++++++++++++++++++-----
 2 files changed, 31 insertions(+), 8 deletions(-)

Backport: Remove the check for inttypes.h and assume it's always there.

From b4915e2ce90ecf321e184fc793398a2160e72168 Mon Sep 17 00:00:00 2001
From: abadger1999 <abadger1999>
Date: Tue, 22 Jan 2008 00:32:23 +0000
Subject: [PATCH] * Check that the size of the image doesn't overflow our
 variables.

---
 lib/dgif_lib.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/dgif_lib.c b/dgif_lib.c
index 3a52467..179bd84 100644
--- a/lib/dgif_lib.c
+++ b/lib/dgif_lib.c
@@ -15,6 +15,8 @@
 #endif
 
 #include <stdlib.h>
+#include <limits.h>
+#include <inttypes.h>
 #if defined (__MSDOS__) && !defined(__DJGPP__) && !defined(__GNUC__)
 #include <io.h>
 #include <alloc.h>
@@ -1054,9 +1056,17 @@ DGifSlurp(GifFileType *GifFile)
                   return (GIF_ERROR);

               sp = &GifFile->SavedImages[GifFile->ImageCount - 1];
+              /* Allocate memory for the image */
+              if (sp->ImageDesc.Width <= 0 || sp->ImageDesc.Height <= 0 ||
+                      sp->ImageDesc.Width > (INT_MAX / sp->ImageDesc.Height)) {
+                  return GIF_ERROR;
+              }
               ImageSize = sp->ImageDesc.Width * sp->ImageDesc.Height;

-              sp->RasterBits = (unsigned char *)malloc(ImageSize *
+              if (ImageSize > (SIZE_MAX / sizeof(GifPixelType))) {
+                  return GIF_ERROR;
+              }
+              sp->RasterBits = (unsigned char *)malloc((size_t)ImageSize *
                                                        sizeof(GifPixelType));
               if (sp->RasterBits == NULL) {
                   return GIF_ERROR;
-- 
2.38.1

